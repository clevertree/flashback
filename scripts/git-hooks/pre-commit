#!/bin/bash

# Git Pre-Commit Hook
# Runs Next.js and Cargo builds to ensure no broken commits
# This hook prevents committing code that doesn't build

set -e

# Colors for output
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
NC='\033[0m' # No Color

echo -e "${BLUE}========================================${NC}"
echo -e "${BLUE}  Pre-Commit Build Verification${NC}"
echo -e "${BLUE}========================================${NC}"
echo ""

# Store the current directory
PROJECT_ROOT="$(git rev-parse --show-toplevel)"
cd "$PROJECT_ROOT"

# Track if any build failed
BUILD_FAILED=0

# Step 1: Run Next.js Build
echo -e "${YELLOW}[1/2]${NC} Building Next.js application..."
echo ""

if npm run build > /tmp/nextjs-build.log 2>&1; then
    echo -e "${GREEN}✓${NC} Next.js build successful"
    echo ""
else
    echo -e "${RED}✗${NC} Next.js build failed!"
    echo ""
    echo -e "${YELLOW}Build Output:${NC}"
    cat /tmp/nextjs-build.log | tail -30
    echo ""
    BUILD_FAILED=1
fi

# Step 2: Run Cargo Build
echo -e "${YELLOW}[2/2]${NC} Building Rust project..."
echo ""

if npm run tauri:build > /tmp/cargo-build.log 2>&1; then
    echo -e "${GREEN}✓${NC} Cargo build successful"
    echo ""
else
    echo -e "${RED}✗${NC} Cargo build failed!"
    echo ""
    echo -e "${YELLOW}Build Output:${NC}"
    tail -50 /tmp/cargo-build.log
    echo ""
    BUILD_FAILED=1
fi

# Summary
echo -e "${BLUE}========================================${NC}"

if [ $BUILD_FAILED -eq 0 ]; then
    echo -e "${GREEN}✓ All builds passed!${NC}"
    echo -e "${GREEN}✓ Commit allowed${NC}"
    echo -e "${BLUE}========================================${NC}"
    echo ""
    exit 0
else
    echo -e "${RED}✗ Build verification failed!${NC}"
    echo -e "${RED}✗ Commit rejected${NC}"
    echo -e "${BLUE}========================================${NC}"
    echo ""
    echo -e "${YELLOW}To commit anyway, use:${NC}"
    echo "  git commit --no-verify"
    echo ""
    exit 1
fi
